/**
 * ControlWorkbench PROS Library
 * Version: 1.0.0
 * 
 * The most comprehensive VEX V5 robotics library for PROS.
 * 
 * MODULES:
 *   - Telemetry: Real-time data streaming to ControlWorkbench
 *   - PID: Production-ready controllers with motion profiling
 *   - Odometry: High-precision position tracking
 *   - Chassis: Complete drivetrain control with Pure Pursuit
 *   - Subsystems: Ready-to-use intake, lift, pneumatic, flywheel
 *   - Utils: Auton selector, driver curves, match timer
 * 
 * INSTALLATION:
 *   1. Copy the 'cwb' folder to your PROS project's 'include' directory
 *   2. In exactly ONE .cpp file, add before including:
 *        #define CWB_IMPLEMENTATION
 *        #include "cwb/cwb.hpp"
 *   3. In all other files, just:
 *        #include "cwb/cwb.hpp"
 * 
 * QUICK START:
 *   #define CWB_IMPLEMENTATION
 *   #include "cwb/cwb.hpp"
 *   
 *   // Hardware
 *   pros::MotorGroup left_drive({-1, -2, -3}, pros::MotorGearset::blue);
 *   pros::MotorGroup right_drive({4, 5, 6}, pros::MotorGearset::blue);
 *   pros::Imu imu(10);
 *   
 *   // Create chassis
 *   cwb::Chassis chassis(left_drive, right_drive, imu);
 *   
 *   // Create auton selector
 *   cwb::AutonSelector selector;
 *   
 *   void initialize() {
 *       cwb::init();
 *       chassis.calibrate();
 *       
 *       selector.add("Red +", red_positive);
 *       selector.add("Skills", skills);
 *       selector.init();
 *       
 *       cwb::on_emergency_stop([]() {
 *           left_drive.move(0);
 *           right_drive.move(0);
 *       });
 *   }
 *   
 *   void autonomous() {
 *       selector.run();
 *   }
 *   
 *   void opcontrol() {
 *       cwb::Controller master(pros::E_CONTROLLER_MASTER);
 *       master.set_curve(cwb::DriverCurve::desmos, 5.0);
 *       
 *       while (true) {
 *           cwb::update();
 *           chassis.update();
 *           
 *           chassis.arcade(master.get_left_y(), master.get_right_x());
 *           pros::delay(10);
 *       }
 *   }
 * 
 * Copyright (c) 2024 ControlWorkbench
 * MIT License
 */

#pragma once

// Core telemetry and remote parameters
#include "telemetry.hpp"

// PID controllers and motion profiling
#include "pid.hpp"

// Odometry tracking
#include "odometry.hpp"

// Chassis control with Pure Pursuit
#include "chassis.hpp"

// Ready-to-use subsystems
#include "subsystems.hpp"

// Competition utilities
#include "utils.hpp"

namespace cwb {

// =============================================================================
// VERSION INFO
// =============================================================================

struct Version {
    static constexpr int MAJOR = 1;
    static constexpr int MINOR = 0;
    static constexpr int PATCH = 0;
    static constexpr const char* STRING = "1.0.0";
    static constexpr const char* NAME = "ControlWorkbench PROS Library";
    
    static std::string full() {
        return std::string(NAME) + " v" + STRING;
    }
};

// =============================================================================
// DIAGNOSTICS
// =============================================================================

/**
 * Print diagnostic information.
 */
inline void print_diagnostics() {
    log_info("=== " + std::string(Version::NAME) + " ===");
    log_info("Version: " + std::string(Version::STRING));
    log_info("Connected: " + std::string(is_connected() ? "Yes" : "No"));
    
    auto stats = get_stats();
    log_info("TX: " + std::to_string(stats.messages_sent) + 
             " RX: " + std::to_string(stats.messages_received));
    
    if (stats.checksum_errors > 0 || stats.parse_errors > 0) {
        log_warning("Errors - Checksum: " + std::to_string(stats.checksum_errors) +
                    " Parse: " + std::to_string(stats.parse_errors));
    }
    
    log_info("CPU: " + std::to_string(pros::Task::get_count()) + " tasks");
    log_info("Battery: " + std::to_string(pros::battery::get_capacity()) + "%");
}

/**
 * Assert with logging.
 */
inline void assert_true(bool condition, const std::string& message = "Assertion failed") {
    if (!condition) {
        log_error("ASSERT: " + message);
    }
}

// =============================================================================
// CONVENIENCE MACROS
// =============================================================================

} // namespace cwb

/**
 * Create a tunable PID controller.
 */
#define CWB_PID(name, kp, ki, kd) \
    cwb::PIDController name##_pid(#name, kp, ki, kd)

/**
 * Create a tunable PD controller (no integral).
 */
#define CWB_PD(name, kp, kd) \
    cwb::PIDController::createPD(#name, kp, kd)

/**
 * Create a tunable parameter.
 */
#define CWB_PARAM(name, default_val) \
    cwb::TunableParam& name = cwb::param(#name, default_val)

/**
 * Create a tunable parameter with bounds.
 */
#define CWB_PARAM_RANGE(name, default_val, min_val, max_val) \
    cwb::TunableParam& name = cwb::param(#name, default_val, min_val, max_val)


// =============================================================================
// QUICK REFERENCE
// =============================================================================

/*
?????????????????????????????????????????????????????????????????????????????????
?                     CONTROLWORKBENCH QUICK REFERENCE                          ?
?????????????????????????????????????????????????????????????????????????????????
?                                                                               ?
?  INITIALIZATION                                                               ?
?  ??????????????????????????????????????????????????????????????????????????????
?  cwb::init(1);              // UART port 1 (or 0 for USB)                     ?
?  cwb::update();             // Call every loop - REQUIRED                     ?
?  cwb::is_connected();       // Check ControlWorkbench connection              ?
?                                                                               ?
?  CHASSIS                                                                      ?
?  ??????????????????????????????????????????????????????????????????????????????
?  cwb::Chassis chassis(left, right, imu);                                      ?
?  chassis.calibrate();                                                         ?
?  chassis.move_to_point(24, 24);                                               ?
?  chassis.turn_to_heading(90);                                                 ?
?  chassis.follow_path({{0,0}, {24,24}, {48,24}});                              ?
?  chassis.arcade(forward, turn);                                               ?
?                                                                               ?
?  MOTION OPTIONS                                                               ?
?  ??????????????????????????????????????????????????????????????????????????????
?  chassis.move_to_point(24, 24, cwb::MoveOptions()                             ?
?      .set_max_speed(80)                                                       ?
?      .set_timeout(3000)                                                       ?
?      .set_forwards(false));                                                   ?
?                                                                               ?
?  PID CONTROLLERS                                                              ?
?  ??????????????????????????????????????????????????????????????????????????????
?  cwb::PIDController pid("name", kp, ki, kd);                                  ?
?  double output = pid.compute(error, dt);                                      ?
?  if (pid.is_settled()) { ... }                                                ?
?                                                                               ?
?  TUNABLE PARAMETERS                                                           ?
?  ??????????????????????????????????????????????????????????????????????????????
?  cwb::TunableParam& speed = cwb::param("speed", 100, 0, 127);                 ?
?  motor.move(speed.get());                                                     ?
?                                                                               ?
?  SUBSYSTEMS                                                                   ?
?  ??????????????????????????????????????????????????????????????????????????????
?  cwb::Intake intake(motor, optical);                                          ?
?  cwb::Lift lift(motor_group);                                                 ?
?  cwb::Pneumatic clamp('A');                                                   ?
?  cwb::Flywheel flywheel(motor);                                               ?
?                                                                               ?
?  AUTON SELECTOR                                                               ?
?  ??????????????????????????????????????????????????????????????????????????????
?  cwb::AutonSelector selector;                                                 ?
?  selector.add("Red +", red_positive);                                         ?
?  selector.init();  // In initialize()                                         ?
?  selector.run();   // In autonomous()                                         ?
?                                                                               ?
?  DRIVER CONTROL                                                               ?
?  ??????????????????????????????????????????????????????????????????????????????
?  cwb::Controller master(pros::E_CONTROLLER_MASTER);                           ?
?  master.set_curve(cwb::DriverCurve::desmos, 5.0);                             ?
?  int forward = master.get_left_y();  // Curved input                          ?
?  if (master.pressed(DIGITAL_A)) { ... }                                       ?
?                                                                               ?
?  TELEMETRY                                                                    ?
?  ??????????????????????????????????????????????????????????????????????????????
?  cwb::send_odometry(x, y, theta);                                             ?
?  cwb::send_motor(motor);                                                      ?
?  cwb::send_debug_value("name", value);                                        ?
?  cwb::log_info("message");                                                    ?
?                                                                               ?
?  CALLBACKS                                                                    ?
?  ??????????????????????????????????????????????????????????????????????????????
?  cwb::on_emergency_stop([]() { /* STOP EVERYTHING */ });                      ?
?  cwb::on_odometry_reset([](x, y, t) { chassis.set_pose(x, y, t); });          ?
?                                                                               ?
?????????????????????????????????????????????????????????????????????????????????
*/
