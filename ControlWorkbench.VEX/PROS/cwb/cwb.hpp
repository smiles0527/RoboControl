/**
 * ControlWorkbench PROS Library
 * Version: 1.0.0
 * 
 * ?????????????????????????????????????????????????????????????????????????????
 * ?         THE COMPLETE VEX VRC COMPETITION LIBRARY FOR PROS                 ?
 * ?????????????????????????????????????????????????????????????????????????????
 * ?  This is the ONLY library you need for VRC competition.                   ?
 * ?  Everything is included - no other dependencies required.                 ?
 * ?????????????????????????????????????????????????????????????????????????????
 * 
 * MODULES INCLUDED:
 *   • Telemetry     - Real-time data streaming to ControlWorkbench
 *   • PID           - Production-ready controllers with motion profiling
 *   • Odometry      - High-precision position tracking
 *   • Chassis       - Complete drivetrain control with Pure Pursuit
 *   • Subsystems    - Intake, lift, pneumatic, flywheel (ready to use)
 *   • Sensors       - Vision, GPS, distance, optical, line tracker
 *   • Path          - Hermite splines, Bezier curves, velocity profiling
 *   • Logger        - SD card recording, match replay, analysis
 *   • Utils         - Auton selector, driver curves, match timer
 * 
 * INSTALLATION:
 *   1. Copy the 'cwb' folder to your PROS project's 'include' directory
 *   2. In exactly ONE .cpp file, add before including:
 *        #define CWB_IMPLEMENTATION
 *        #include "cwb/cwb.hpp"
 *   3. In all other files, just:
 *        #include "cwb/cwb.hpp"
 * 
 * That's it! No Makefile changes. No other libraries needed.
 * 
 * Copyright (c) 2024 ControlWorkbench
 * MIT License
 */

#pragma once

// ???????????????????????????????????????????????????????????????????????????
// CORE MODULES
// ???????????????????????????????????????????????????????????????????????????

// Real-time telemetry and remote parameter tuning
#include "telemetry.hpp"

// PID controllers with motion profiling
#include "pid.hpp"

// High-precision odometry tracking
#include "odometry.hpp"

// Chassis control with Pure Pursuit
#include "chassis.hpp"

// ???????????????????????????????????????????????????????????????????????????
// SUBSYSTEM MODULES
// ???????????????????????????????????????????????????????????????????????????

// Ready-to-use subsystems: intake, lift, pneumatic, flywheel
#include "subsystems.hpp"

// Sensor wrappers: vision, GPS, distance, optical, line tracker, IMU
#include "sensors.hpp"

// ???????????????????????????????????????????????????????????????????????????
// PATH & PLANNING
// ???????????????????????????????????????????????????????????????????????????

// Path generation: splines, Bezier curves, velocity profiling
#include "path.hpp"

// ???????????????????????????????????????????????????????????????????????????
// UTILITIES
// ???????????????????????????????????????????????????????????????????????????

// Competition utilities: auton selector, driver curves, match timer
#include "utils.hpp"

// Data logging: SD card recording, match replay, analysis
#include "logger.hpp"

namespace cwb {

// ???????????????????????????????????????????????????????????????????????????
// VERSION INFO
// ???????????????????????????????????????????????????????????????????????????

struct Version {
    static constexpr int MAJOR = 1;
    static constexpr int MINOR = 0;
    static constexpr int PATCH = 0;
    static constexpr const char* STRING = "1.0.0";
    static constexpr const char* NAME = "ControlWorkbench PROS Library";
    
    static std::string full() {
        return std::string(NAME) + " v" + STRING;
    }
};

// ???????????????????????????????????????????????????????????????????????????
// DIAGNOSTICS
// ???????????????????????????????????????????????????????????????????????????

/**
 * Print diagnostic information to ControlWorkbench console.
 */
inline void print_diagnostics() {
    log_info("?????????????????????????????????????????????");
    log_info("?     " + std::string(Version::NAME) + "     ?");
    log_info("?????????????????????????????????????????????");
    log_info("? Version: " + std::string(Version::STRING));
    log_info("? Connected: " + std::string(is_connected() ? "Yes ?" : "No ?"));
    
    auto stats = get_stats();
    log_info("? TX: " + std::to_string(stats.messages_sent) + 
             " RX: " + std::to_string(stats.messages_received));
    
    if (stats.checksum_errors > 0 || stats.parse_errors > 0) {
        log_warning("? Errors: " + std::to_string(stats.checksum_errors + stats.parse_errors));
    }
    
    log_info("? Tasks: " + std::to_string(pros::Task::get_count()));
    log_info("? Battery: " + std::to_string(static_cast<int>(pros::battery::get_capacity())) + "%");
    log_info("? Voltage: " + std::to_string(pros::battery::get_voltage() / 1000.0).substr(0,4) + "V");
    log_info("?????????????????????????????????????????????");
}

/**
 * Run system check and report issues.
 */
inline void system_check() {
    log_info("Running system check...");
    
    // Check battery
    double voltage = pros::battery::get_voltage() / 1000.0;
    double capacity = pros::battery::get_capacity();
    
    if (voltage < 7.5) {
        log_error("? Battery CRITICAL: " + std::to_string(voltage).substr(0,4) + "V");
    } else if (voltage < 7.8) {
        log_warning("? Battery low: " + std::to_string(voltage).substr(0,4) + "V");
    } else {
        log_info("? Battery OK: " + std::to_string(voltage).substr(0,4) + "V (" + 
                 std::to_string(static_cast<int>(capacity)) + "%)");
    }
    
    // Check temperature
    double temp = pros::battery::get_temperature();
    if (temp > 45) {
        log_warning("? Battery temperature high: " + std::to_string(temp).substr(0,4) + "°C");
    } else {
        log_info("? Battery temp OK: " + std::to_string(temp).substr(0,4) + "°C");
    }
    
    // Check competition control
    if (pros::competition::is_connected()) {
        log_info("? Competition control connected");
    } else {
        log_info("? No competition control");
    }
    
    log_info("System check complete.");
}

/**
 * Assert with logging.
 */
inline void assert_true(bool condition, const std::string& message = "Assertion failed") {
    if (!condition) {
        log_error("ASSERT: " + message);
    }
}

} // namespace cwb

// ???????????????????????????????????????????????????????????????????????????
// CONVENIENCE MACROS
// ???????????????????????????????????????????????????????????????????????????

/**
 * Create a tunable PID controller.
 */
#define CWB_PID(name, kp, ki, kd) \
    cwb::PIDController name##_pid(#name, kp, ki, kd)

/**
 * Create a tunable PD controller (no integral).
 */
#define CWB_PD(name, kp, kd) \
    cwb::PIDController::createPD(#name, kp, kd)

/**
 * Create a tunable parameter.
 */
#define CWB_PARAM(name, default_val) \
    cwb::TunableParam& name = cwb::param(#name, default_val)

/**
 * Create a tunable parameter with bounds.
 */
#define CWB_PARAM_RANGE(name, default_val, min_val, max_val) \
    cwb::TunableParam& name = cwb::param(#name, default_val, min_val, max_val)


// ???????????????????????????????????????????????????????????????????????????
// COMPLETE API QUICK REFERENCE
// ???????????????????????????????????????????????????????????????????????????

/*
?????????????????????????????????????????????????????????????????????????????????
?                     CONTROLWORKBENCH COMPLETE API                             ?
?????????????????????????????????????????????????????????????????????????????????
?                                                                               ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  ? INITIALIZATION                                                          ?  ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  cwb::init(1);              // UART port 1 (or 0 for USB)                     ?
?  cwb::update();             // Call every loop - REQUIRED                     ?
?  cwb::is_connected();       // Check ControlWorkbench connection              ?
?  cwb::print_diagnostics();  // Print system info                              ?
?  cwb::system_check();       // Run system check                               ?
?                                                                               ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  ? CHASSIS CONTROL                                                         ?  ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  cwb::Chassis chassis(left, right, imu);                                      ?
?  chassis.calibrate();                                                         ?
?  chassis.move_to_point(24, 24);         // Drive to point                     ?
?  chassis.turn_to_heading(90);           // Turn to heading                    ?
?  chassis.follow_path(path);             // Pure Pursuit                       ?
?  chassis.boomerang(x, y, heading);      // Curved approach                    ?
?  chassis.arcade(forward, turn);         // Driver control                     ?
?                                                                               ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  ? SUBSYSTEMS                                                              ?  ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  cwb::Intake intake(motor, optical);    // Color sorting built-in             ?
?  cwb::Lift lift(motors);                // PID hold + presets                 ?
?  cwb::Pneumatic clamp('A');             // Single/double acting               ?
?  cwb::Flywheel flywheel(motor);         // Velocity control                   ?
?                                                                               ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  ? SENSORS                                                                 ?  ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  cwb::Vision vision(1);                 // Object tracking                    ?
?  cwb::GPS gps(1, 0, 0);                 // Position + heading                 ?
?  cwb::Distance dist(1);                 // Filtered distance                  ?
?  cwb::Optical optical(1);               // Color detection                    ?
?  cwb::LineArray lines({'A','B','C'});   // Line following                     ?
?  cwb::IMU imu(1);                       // Enhanced IMU                       ?
?                                                                               ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  ? PATH GENERATION                                                         ?  ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  cwb::PathGenerator gen;                                                      ?
?  auto path = gen.generate(waypoints);   // Smooth spline path                 ?
?  path = cwb::PathUtils::mirror(path);   // Mirror for opposite alliance       ?
?  path = cwb::PathUtils::reverse(path);  // Reverse for driving backward       ?
?                                                                               ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  ? AUTON SELECTOR                                                          ?  ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  cwb::AutonSelector selector;                                                 ?
?  selector.add("Red +", red_positive);                                         ?
?  selector.add("Skills", skills);                                              ?
?  selector.init();           // In initialize()                                ?
?  selector.run();            // In autonomous()                                ?
?                                                                               ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  ? DRIVER CONTROL                                                          ?  ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  cwb::Controller master(pros::E_CONTROLLER_MASTER);                           ?
?  master.set_curve(cwb::DriverCurve::desmos, 5.0);                             ?
?  int forward = master.get_left_y();     // Curved input                       ?
?  if (master.pressed(DIGITAL_A)) { }     // New press detection                ?
?                                                                               ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  ? DATA LOGGING                                                            ?  ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  cwb::Logger logger;                                                          ?
?  logger.start("match");     // Start logging to SD                            ?
?  logger.log("x", x);        // Log values                                     ?
?  logger.tick();             // Write row                                      ?
?                                                                               ?
?  cwb::MatchRecorder recorder;                                                 ?
?  recorder.start_autonomous();                                                 ?
?  recorder.record(x, y, theta, left, right);                                   ?
?  recorder.save("skills.csv");                                                 ?
?                                                                               ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  ? MATCH TIMER                                                             ?  ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  cwb::MatchTimer::start(cwb::MatchTimer::Mode::Skills);                       ?
?  if (cwb::MatchTimer::is_endgame()) { }                                       ?
?  std::string time = cwb::MatchTimer::format_remaining();                      ?
?                                                                               ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  ? TELEMETRY                                                               ?  ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  cwb::send_odometry(x, y, theta);       // Position                           ?
?  cwb::send_motor(motor);                // Motor data                         ?
?  cwb::send_debug_value("name", value);  // Custom values                      ?
?  cwb::log_info("message");              // Console messages                   ?
?                                                                               ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  ? CALLBACKS (CRITICAL!)                                                   ?  ?
?  ???????????????????????????????????????????????????????????????????????????  ?
?  cwb::on_emergency_stop([]() {                                                ?
?      // STOP ALL MOTORS AND ACTUATORS!                                        ?
?  });                                                                          ?
?                                                                               ?
?????????????????????????????????????????????????????????????????????????????????
*/
