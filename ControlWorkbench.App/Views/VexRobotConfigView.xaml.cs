using System.Text;
using System.Windows;
using System.Windows.Controls;

namespace ControlWorkbench.App.Views;

/// <summary>
/// VEX Robot Configuration view with PROS code generation.
/// </summary>
public partial class VexRobotConfigView : UserControl
{
    private RobotConfig _config = new();

    public VexRobotConfigView()
    {
        InitializeComponent();
        Loaded += OnLoaded;
    }

    private void OnLoaded(object sender, RoutedEventArgs e)
    {
        WireUpEvents();
        UpdateCodePreview();
    }

    private void WireUpEvents()
    {
        TeamNumber.TextChanged += (s, ev) => { _config.TeamNumber = TeamNumber.Text; UpdateCodePreview(); };
        RobotName.TextChanged += (s, ev) => { _config.RobotName = RobotName.Text; UpdateCodePreview(); };
        LibraryChoice.SelectionChanged += (s, ev) => UpdateCodePreview();
        DriveType.SelectionChanged += (s, ev) => UpdateCodePreview();
        CartridgeType.SelectionChanged += (s, ev) => UpdateCodePreview();
        GenerateButton.Click += OnGenerateClick;
        PreviewFileSelect.SelectionChanged += (s, ev) => UpdateCodePreview();
    }

    private void UpdateCodePreview()
    {
        ReadConfigFromUI();
        string selectedFile = (PreviewFileSelect.SelectedItem as ComboBoxItem)?.Content?.ToString() ?? "main.cpp";
        
        CodePreviewBox.Text = selectedFile switch
        {
            "main.cpp" => GenerateMainCpp(),
            "robot.hpp" => GenerateRobotHpp(),
            "robot.cpp" => GenerateRobotCpp(),
            "autons.cpp" => GenerateAutonsCpp(),
            _ => GenerateMainCpp()
        };
    }

    private void ReadConfigFromUI()
    {
        _config.TeamNumber = TeamNumber.Text;
        _config.RobotName = RobotName.Text;
        _config.Library = LibraryChoice.SelectedIndex switch
        {
            0 => "LemLib",
            1 => "EZ-Template",
            2 => "PROS",
            3 => "VEXcode",
            _ => "LemLib"
        };
        
        _config.DriveType = DriveType.SelectedIndex switch
        {
            0 => "Tank6",
            1 => "Tank4",
            2 => "HDrive",
            3 => "XDrive",
            4 => "Mecanum",
            _ => "Tank6"
        };

        _config.Cartridge = CartridgeType.SelectedIndex switch
        {
            0 => "red",
            1 => "green",
            2 => "blue",
            _ => "blue"
        };

        _config.CartridgeRpm = CartridgeType.SelectedIndex switch
        {
            0 => 100,
            1 => 200,
            2 => 600,
            _ => 600
        };
    }

    private string GenerateMainCpp()
    {
        var sb = new StringBuilder();
        sb.AppendLine("#include \"main.h\"");
        
        if (_config.Library == "LemLib")
            sb.AppendLine("#include \"lemlib/api.hpp\"");
        else if (_config.Library == "EZ-Template")
            sb.AppendLine("#include \"EZ-Template/api.hpp\"");
        
        sb.AppendLine("#include \"robot.hpp\"");
        sb.AppendLine("#include \"autons.hpp\"");
        sb.AppendLine();
        sb.AppendLine("/**");
        sb.AppendLine(" * Robot code generated by ControlWorkbench");
        sb.AppendLine(" * Team: " + _config.TeamNumber);
        sb.AppendLine(" * Robot: " + _config.RobotName);
        sb.AppendLine(" */");
        sb.AppendLine();
        sb.AppendLine("void initialize() {");
        sb.AppendLine("    pros::lcd::initialize();");
        sb.AppendLine("    robot::initialize();");
        
        if (_config.Library == "LemLib")
        {
            sb.AppendLine("    robot::chassis.calibrate();");
        }
        
        sb.AppendLine("}");
        sb.AppendLine();
        sb.AppendLine("void disabled() {}");
        sb.AppendLine("void competition_initialize() {}");
        sb.AppendLine();
        sb.AppendLine("void autonomous() {");
        sb.AppendLine("    auton::run_selected();");
        sb.AppendLine("}");
        sb.AppendLine();
        sb.AppendLine("void opcontrol() {");
        sb.AppendLine("    pros::Controller master(pros::E_CONTROLLER_MASTER);");
        sb.AppendLine("    ");
        sb.AppendLine("    while (true) {");
        sb.AppendLine("        int left = master.get_analog(ANALOG_LEFT_Y);");
        sb.AppendLine("        int right = master.get_analog(ANALOG_RIGHT_Y);");
        
        if (_config.Library == "LemLib")
            sb.AppendLine("        robot::chassis.tank(left, right);");
        else
            sb.AppendLine("        robot::drive_tank(left, right);");
        
        sb.AppendLine("        ");
        sb.AppendLine("        // Intake");
        sb.AppendLine("        if (master.get_digital(DIGITAL_R1))");
        sb.AppendLine("            robot::intake.move(127);");
        sb.AppendLine("        else if (master.get_digital(DIGITAL_R2))");
        sb.AppendLine("            robot::intake.move(-127);");
        sb.AppendLine("        else");
        sb.AppendLine("            robot::intake.move(0);");
        sb.AppendLine("        ");
        sb.AppendLine("        // Mogo clamp");
        sb.AppendLine("        if (master.get_digital_new_press(DIGITAL_L1))");
        sb.AppendLine("            robot::mogo_clamp.toggle();");
        sb.AppendLine("        ");
        sb.AppendLine("        pros::delay(10);");
        sb.AppendLine("    }");
        sb.AppendLine("}");

        return sb.ToString();
    }

    private string GenerateRobotHpp()
    {
        var sb = new StringBuilder();
        sb.AppendLine("#pragma once");
        sb.AppendLine("#include \"main.h\"");
        if (_config.Library == "LemLib")
            sb.AppendLine("#include \"lemlib/api.hpp\"");
        sb.AppendLine();
        sb.AppendLine("namespace robot {");
        sb.AppendLine();
        sb.AppendLine("// Motor ports");
        sb.AppendLine("constexpr int LEFT_FRONT = 1;");
        sb.AppendLine("constexpr int LEFT_MIDDLE = 2;");
        sb.AppendLine("constexpr int LEFT_BACK = 3;");
        sb.AppendLine("constexpr int RIGHT_FRONT = 4;");
        sb.AppendLine("constexpr int RIGHT_MIDDLE = 5;");
        sb.AppendLine("constexpr int RIGHT_BACK = 6;");
        sb.AppendLine("constexpr int INTAKE_PORT = 7;");
        sb.AppendLine();
        sb.AppendLine("// Sensor ports");
        sb.AppendLine("constexpr int IMU_PORT = 10;");
        sb.AppendLine();
        sb.AppendLine("// Drivetrain constants");
        sb.AppendLine("constexpr double WHEEL_DIAMETER = 3.25;");
        sb.AppendLine("constexpr double TRACK_WIDTH = 12.0;");
        sb.AppendLine();
        sb.AppendLine("// Declarations");
        sb.AppendLine("extern pros::Motor intake;");
        sb.AppendLine("extern pros::adi::Pneumatics mogo_clamp;");
        if (_config.Library == "LemLib")
            sb.AppendLine("extern lemlib::Chassis chassis;");
        sb.AppendLine();
        sb.AppendLine("void initialize();");
        sb.AppendLine("void drive_tank(int left, int right);");
        sb.AppendLine();
        sb.AppendLine("} // namespace robot");

        return sb.ToString();
    }

    private string GenerateRobotCpp()
    {
        string cartridgeUpper = _config.Cartridge.ToUpper();
        
        var sb = new StringBuilder();
        sb.AppendLine("#include \"robot.hpp\"");
        sb.AppendLine();
        sb.AppendLine("namespace robot {");
        sb.AppendLine();
        sb.AppendLine("// Motors");
        sb.AppendLine("pros::Motor left_front(LEFT_FRONT, pros::E_MOTOR_GEAR_" + cartridgeUpper + ", true);");
        sb.AppendLine("pros::Motor left_middle(LEFT_MIDDLE, pros::E_MOTOR_GEAR_" + cartridgeUpper + ", true);");
        sb.AppendLine("pros::Motor left_back(LEFT_BACK, pros::E_MOTOR_GEAR_" + cartridgeUpper + ", true);");
        sb.AppendLine("pros::Motor right_front(RIGHT_FRONT, pros::E_MOTOR_GEAR_" + cartridgeUpper + ", false);");
        sb.AppendLine("pros::Motor right_middle(RIGHT_MIDDLE, pros::E_MOTOR_GEAR_" + cartridgeUpper + ", false);");
        sb.AppendLine("pros::Motor right_back(RIGHT_BACK, pros::E_MOTOR_GEAR_" + cartridgeUpper + ", false);");
        sb.AppendLine("pros::Motor intake(INTAKE_PORT, pros::E_MOTOR_GEAR_" + cartridgeUpper + ", false);");
        sb.AppendLine();
        sb.AppendLine("pros::MotorGroup left_motors({left_front, left_middle, left_back});");
        sb.AppendLine("pros::MotorGroup right_motors({right_front, right_middle, right_back});");
        sb.AppendLine();
        sb.AppendLine("pros::IMU imu(IMU_PORT);");
        sb.AppendLine("pros::adi::Pneumatics mogo_clamp('A', false);");
        sb.AppendLine();

        if (_config.Library == "LemLib")
        {
            sb.AppendLine("// LemLib setup");
            sb.AppendLine("lemlib::Drivetrain drivetrain(");
            sb.AppendLine("    &left_motors, &right_motors,");
            sb.AppendLine("    TRACK_WIDTH,");
            sb.AppendLine("    lemlib::Omniwheel::NEW_325,");
            sb.AppendLine("    " + _config.CartridgeRpm + ",");
            sb.AppendLine("    2");
            sb.AppendLine(");");
            sb.AppendLine();
            sb.AppendLine("lemlib::OdomSensors sensors(nullptr, nullptr, nullptr, nullptr, &imu);");
            sb.AppendLine();
            sb.AppendLine("lemlib::ControllerSettings lateral(10, 0, 3, 3, 1, 100, 3, 500, 20);");
            sb.AppendLine("lemlib::ControllerSettings angular(2, 0, 10, 3, 1, 100, 3, 500, 0);");
            sb.AppendLine();
            sb.AppendLine("lemlib::Chassis chassis(drivetrain, lateral, angular, sensors);");
            sb.AppendLine();
        }

        sb.AppendLine("void initialize() {");
        sb.AppendLine("    imu.reset();");
        sb.AppendLine("}");
        sb.AppendLine();
        sb.AppendLine("void drive_tank(int left, int right) {");
        sb.AppendLine("    left_motors.move(left);");
        sb.AppendLine("    right_motors.move(right);");
        sb.AppendLine("}");
        sb.AppendLine();
        sb.AppendLine("} // namespace robot");

        return sb.ToString();
    }

    private string GenerateAutonsCpp()
    {
        var sb = new StringBuilder();
        sb.AppendLine("#include \"main.h\"");
        sb.AppendLine("#include \"robot.hpp\"");
        sb.AppendLine();
        sb.AppendLine("namespace auton {");
        sb.AppendLine();
        sb.AppendLine("int selected = 0;");
        sb.AppendLine();
        sb.AppendLine("void do_nothing() {}");
        sb.AppendLine();
        sb.AppendLine("void red_positive() {");
        if (_config.Library == "LemLib")
        {
            sb.AppendLine("    robot::chassis.setPose(0, 0, 0);");
            sb.AppendLine("    robot::chassis.moveToPose(24, 24, 45, 4000);");
            sb.AppendLine("    robot::mogo_clamp.extend();");
            sb.AppendLine("    pros::delay(200);");
            sb.AppendLine("    robot::intake.move(127);");
            sb.AppendLine("    robot::chassis.moveToPose(48, 48, 90, 3000);");
        }
        else
        {
            sb.AppendLine("    robot::drive_tank(60, 60);");
            sb.AppendLine("    pros::delay(1000);");
            sb.AppendLine("    robot::drive_tank(0, 0);");
        }
        sb.AppendLine("}");
        sb.AppendLine();
        sb.AppendLine("void red_negative() { }");
        sb.AppendLine("void blue_positive() { }");
        sb.AppendLine("void blue_negative() { }");
        sb.AppendLine("void skills() { }");
        sb.AppendLine();
        sb.AppendLine("void run_selected() {");
        sb.AppendLine("    switch (selected) {");
        sb.AppendLine("        case 0: do_nothing(); break;");
        sb.AppendLine("        case 1: red_positive(); break;");
        sb.AppendLine("        case 2: red_negative(); break;");
        sb.AppendLine("        case 3: blue_positive(); break;");
        sb.AppendLine("        case 4: blue_negative(); break;");
        sb.AppendLine("        case 5: skills(); break;");
        sb.AppendLine("    }");
        sb.AppendLine("}");
        sb.AppendLine();
        sb.AppendLine("} // namespace auton");

        return sb.ToString();
    }

    private void OnGenerateClick(object sender, RoutedEventArgs e)
    {
        ReadConfigFromUI();
        
        // Use OpenFolderDialog from WPF or a simple approach
        var dialog = new Microsoft.Win32.SaveFileDialog
        {
            Title = "Select folder and filename for project",
            FileName = "project",
            Filter = "Folder|*.folder"
        };

        if (dialog.ShowDialog() == true)
        {
            string folder = System.IO.Path.GetDirectoryName(dialog.FileName) ?? "";
            string srcFolder = System.IO.Path.Combine(folder, "src");
            string includeFolder = System.IO.Path.Combine(folder, "include");
            
            System.IO.Directory.CreateDirectory(srcFolder);
            System.IO.Directory.CreateDirectory(includeFolder);

            System.IO.File.WriteAllText(System.IO.Path.Combine(srcFolder, "main.cpp"), GenerateMainCpp());
            System.IO.File.WriteAllText(System.IO.Path.Combine(srcFolder, "robot.cpp"), GenerateRobotCpp());
            System.IO.File.WriteAllText(System.IO.Path.Combine(srcFolder, "autons.cpp"), GenerateAutonsCpp());
            System.IO.File.WriteAllText(System.IO.Path.Combine(includeFolder, "robot.hpp"), GenerateRobotHpp());

            // Also create autons.hpp
            var autonsHpp = new StringBuilder();
            autonsHpp.AppendLine("#pragma once");
            autonsHpp.AppendLine("namespace auton {");
            autonsHpp.AppendLine("    extern int selected;");
            autonsHpp.AppendLine("    void run_selected();");
            autonsHpp.AppendLine("}");
            System.IO.File.WriteAllText(System.IO.Path.Combine(includeFolder, "autons.hpp"), autonsHpp.ToString());

            MessageBox.Show("PROS project files saved to:\n" + folder, "Generated", MessageBoxButton.OK, MessageBoxImage.Information);
        }
    }

    private class RobotConfig
    {
        public string TeamNumber { get; set; } = "1234A";
        public string RobotName { get; set; } = "Competition Bot";
        public string Library { get; set; } = "LemLib";
        public string DriveType { get; set; } = "Tank6";
        public string Cartridge { get; set; } = "blue";
        public int CartridgeRpm { get; set; } = 600;
    }
}
